name: SonarQube Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sonar:
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:20.10.16
        options: --privileged
        ports:
          - 9000:9000
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock

    steps:
    - name: Check out code
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: Start SonarQube Docker container
      run: |
        docker run -d --name sonarqube \
          -p 9000:9000 \
          -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
          sonarqube:community
        
        # Wait for SonarQube to be fully started
        until curl -s http://localhost:9000/api/system/status | grep -q "UP"; do sleep 10; done

    - name: Run SonarQube analysis
      run: |
          docker run --rm \
                -e SONAR_HOST_URL="http://localhost:9000" \
                -e SONAR_LOGIN="${{ secrets.SONAR_TOKEN }}" \
               -v "$(pwd):/usr/src" \
               sonarsource/sonar-scanner-cli \
               sonar-scanner -X

    - name: Stop SonarQube Docker container
      run: docker stop sonarqube && docker rm sonarqube
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN}}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL}}
